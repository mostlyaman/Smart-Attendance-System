<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>- Smart Attendance</title>
    <script src="js/authenticated.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.1/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-+0n0xVW2eSR5OomGNYDnhzAbDsOXxcvSN1TPprVMTNDbiYZCxYbOOl7+AMvyTG2x" crossorigin="anonymous">
    <link rel="stylesheet" href="css/header.css">
</head>
<body>
    <header class="site-header" style="z-index: 100;">
        <div class="wrapper site-header__wrapper">
            <a href="#" class="brand">Smart Attendance Portal</a>
            <nav class="nav">
                <div class="nav__toggle" aria-expanded="false" type="button"
                    style="background-color: #a7e5fc; padding:5px 10px;border-radius: 5px;">
                    menu
                </div>
                <ul class="nav__wrapper">
                    <li class="nav__item" id="add-your-image" style="display:none">
                        <form action="/api/v1/upload_image" method="post" enctype="multipart/form-data" id="image-form">
                            <label for="add-your-image-input">Mark Attendance</label>    
                            <input type="file" name="add-your-image-input" id="add-your-image-input" style="display:none"> 
                        </form>                            
                    </li>
                    <!-- <li class="nav__item" id="add-your-image" style="display:none">
                        <form action="/api/v1/upload_image" method="post" enctype="multipart/form-data" id="image-form">
                            <label for="add-your-image-input">Add your Image</label>    
                            <input type="file" name="add-your-image-input" id="add-your-image-input" style="display:none"> 
                        </form>                            
                    </li> -->
                    <li class="nav__item" id="profile">...</li>
                    <li class="nav__item" id="logout">Logout</li>
                    <style>
                        li {
                            padding: 24px 16px;
                        }
                    
                        li:hover, li > label:hover {
                            text-decoration: underline;
                            cursor: pointer
                        }
                    </style>
                    <script>
                        document.getElementById('add-your-image-input').addEventListener('change', async (event) => {
                            let form = new FormData(document.querySelector('#image-form'))
                            await fetch("/api/v1/mark_attendance", {
                                method: 'POST',
                                body: form
                            })
                                .then(async (res) => {
                                    if(res.status == 200){
                                        alert(JSON.stringify(res))
                                    } 
                                        
                                    else {
                                        const response = await res.json()
                                        console.error(response)
                                        alert(response.message)
                                    }
                                })
                                .catch((err) => {
                                    console.error(err)
                                    alert(err)
                                })
                            event.preventDefault()
                        
                        })
                        document.getElementById('profile').addEventListener('click', async () => {
                            const res = await fetch('/api/v1/switch')
                            if(res.status == 200) {
                                location.reload()
                            } else {
                                const j = await res.json()
                                console.error(j)
                                alert(j.message)
                            }
                        })
                        document.getElementById('logout').addEventListener('click', async () => {
                            await fetch('/api/v1/logout')
                                .then((res) => {
                                    if (res.status == 200) window.location.replace('/login.html')
                                    else {
                                        alert("Something went wrong.")
                                    }
                                })
                                .catch((err) => {
                                    console.error(err)
                                    alert(err)
                                })
                        })
                    </script>

                </ul>
            </nav>
            
        </div>
    </header>

    <div class="container p-5">
        <div class="m-3" style="display:flex; flex-direction: row;">
            <div style="flex:1">
                <h1 style="color: #262647 !important; font-size: x-large;"><b id="welcome"></b></h1>
                <h4 style="color: #262647 !important;" class="mt-2" id="your-courses"></h4>
            </div>
        </div>
        <h1 style="color: #262647 !important; font-size: larger; text-align: center;"><b id="no-classes" style="margin-top: 50px; display: none;"></b></h1>
        <div id="table-container" class="card m-3 mt-5 p-4 border-0  shadow-lg" style="border-radius: 1rem !important;display:none">
			<div class="table-responsive">
                <table class="table table-bordered" id="courses-table" border="1">
                </table>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/gh/Rakhmadi/RdataTB@master/dist/index.js"></script>

    <script src="js/header.js"></script>

    <script>
        document.querySelector('#logout').addEventListener('click', async () => {
            await fetch('/api/v1/logout')
                .then((res) => { if (response.status == 200) window.location.href = '/login.html' })
                .catch((err) => {
                    console.error(err);

                })
        })

        contains = (element, list) => {
            for(i = 0; i<list.length; i++) {
                if(element == list[i]) return true;
            }
            return false
        }

        getData = async () => {
            // fetch Data
            await fetch('/api/v1/course')
                .then(async (res) => {
                    if (res.status != 200) {
                        res = await res.json()
                        alert(res.message)
                        console.error(res)
                        return
                    }
                    
                    let data = await res.json();
                    console.log(data)
                    document.getElementById('profile').innerText = `${data.name} - ${data.is_instructor ? "Instructor" : "Student"} (Switch)`
                    document.getElementById('welcome').innerText = `[${data.table.code}] - ${data.table.name}`
                    document.getElementById('your-courses').innerText = `Instructor: ${data.table.instructor}`
                    document.getElementById('add-your-image').style.display = !data.is_instructor ? "none" : "block"


                    const table = document.getElementById('courses-table')
                    if(data.days.length != 0) {
                        if(data.is_instructor) {
                            temp_days = ""
                            data.days.forEach((item) => {temp_days+=`<th>${item}</th>`})
                            console.log(temp_days, data.days)
                            table.innerHTML = `					
                                <thead>
                                    <tr>
                                        <th>Student Name</th>
                                        ${temp_days}
                                    </tr>
                                </thead>
                                <tbody id="courses-table-body">
                                </tbody>`
                                const table_body = document.getElementById('courses-table-body')
                                let temp = ""
                                data.students.forEach((item) => {
                                    temp+=`
                                        <tr>
                                            <td>${item[1]}</td>
                                            ${data.days.map((it) => `<th>${contains(it[0], data.result[item[0]]) ? "P" : "A" }</th>`)}
                                        </tr>
                                    `
                                })
                                table_body.innerHTML = temp
                            
                        }

                        let x = new RdataTB('courses-table', {
                            // RenderJSON: data.result,
                            ShowSearch:false, 
                            ShowSelect:false,
                            HideColumn:["id", "P", "A"]
                        })
                        document.getElementById('table-container').style.display = 'block'
                    } else {
                        document.getElementById('no-classes').innerText = "There have been no classes this semester."
                        document.getElementById('no-classes').style.display = 'block'
                    }

                })
                .catch((err)=> {
                        console.error(err)
                        alert("Something went wrong.")
                })
        }
        getData()

    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.1/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-gtEjrD/SeCtmISkJkNUaaKMoLD0//ElJ19smozuHV6z3Iehds+3Ulb9Bn9Plx0x4"
    crossorigin="anonymous"></script>

    <style>
        tbody > tr:hover {
            background-color: #e3e3e3;
            cursor: pointer;
            text-decoration: underline;
        }

        th {
            font-weight: 600;
            font-size: 16px;
            /* border: 2px rgba(74, 71, 71, 0.1) solid !important; */
            padding: 20px !important;
            background-color: #B7EAFB !important;
        }

        td{
            padding: 20px !important;
            border: 2px rgba(74, 71, 71, 0.1) solid !important;

        }
        .Selc {
            display: none;
        }

        #courses-table > thead > tr :nth-child(1) {
            border-top-left-radius: 20px;
        } 
        #courses-table > thead > tr :last-child {
            border-top-right-radius: 20px;
        } 
        tr > :last-child {
            padding-top: 0px !important;
            padding-bottom: 0px !important;
        }
    </style>
</body>
</html>